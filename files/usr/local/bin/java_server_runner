#!/usr/bin/env bash

function memory_limits {
    # If limits have not been passed to us then try to discover them
    if [ -z $MAX_HEAP_SIZE_XMX ]; then
        if [ -f /sys/fs/cgroup/memory/memory.max_usage_in_bytes ]; then
            MEMLIM=$(cat /sys/fs/cgroup/memory/memory.max_usage_in_bytes)
            MEMLIM=$(expr $MEMLIM / 1024 / 1024)
            [ $MEMLIM -lt 512 ] && MEMLIM=512
            export MAX_HEAP_SIZE_XMX=${MEMLIM}m
            echo "INFO: Imposing memory limit of $MAX_HEAP_SIZE_XMX"
        else
            export MAX_HEAP_SIZE_XMX=512m
            echo "WARNING: Imposing default memory limit of $MAX_HEAP_SIZE_XMX"
        fi
    fi
}

function tomcat_webapps {
    if [ ! -d /var/www/webapps ]; then
        cp -R /opt/apache-tomcat-*/webapps /var/www
    fi
}

function tomcat_config {
    echo "Applying tomcat config"
    for envar in TC_MGR_GUI_USER \
                 TC_MGR_GUI_PASS \
                 TC_MGR_SCRIPT_USER \
                 TC_MGR_SCRIPT_PASS \
                 TC_MGR_JMX_USER \
                 TC_MGR_JMX_PASS \
                 TC_MGR_STATUS_USER \
                 TC_MGR_STATUS_PASS \
                 TC_ADMIN_GUI_USER \
                 TC_ADMIN_GUI_PASS \
                 TC_ADMIN_SCRIPT_USER \
                 TC_ADMIN_SCRIPT_PASS \
                 MAX_HEAP_SIZE_XMX
    do
        eval value=\$$envar
        find /opt/tomcat/ -type f -exec sed -i "s/<$envar>/$value/g" {} \;
    done

    cp -ruv /opt/tomcat/conf/* /usr/share/tomcat/conf
    cp -ruv /opt/tomcat/bin/* /usr/share/tomcat/bin
    cp -ruv /opt/tomcat/webapps/* /var/www/webapps/
}

memory_limits
tomcat_webapps
tomcat_config

echo "Starting tomcat server..."
/usr/share/tomcat/bin/catalina.sh run
# The above always exits with 0, which is probably not what we want
# as it's supposed to run forever
exit 1
